from texera.cmdhelp import CmdHelp
from os import remove, execle, path, environ
from git import Repo
from git.exc import GitCommandError, InvalidGitRepositoryError, NoSuchPathError
import asyncio
import sys
from texera import CMD_HELP, HEROKU_APIKEY, HEROKU_APPNAME, UPSTREAM_REPO_URL, idm
from pyrogram import Client, filters





requirements_path = path.join(
    path.dirname(path.dirname(path.dirname(__file__))), 'requirements.txt')


async def gen_chlog(repo, diff):
    ch_log = ''
    d_form = "%d/%m/%y"
    for c in repo.iter_commits(diff):
        ch_log += f'‚Ä¢[{c.committed_datetime.strftime(d_form)}]: {c.summary} <{c.author}>\n'
    return ch_log


async def update_requirements():
    reqs = str(requirements_path)
    try:
        process = await asyncio.create_subprocess_shell(
            ' '.join([sys.executable, "-m", "pip", "install", "-r", reqs]),
            stdout=asyncio.subprocess.PIPE,
            stderr=asyncio.subprocess.PIPE)
        await process.communicate()
        return process.returncode
    except Exception as e:
        return repr(e)


@Client.on_message(filters.command("update",[",",".","!"]) & filters.me)
async def upstream(c:Client ,m):
    ".update komutu ile botunun g√ºncel olup olmadƒ±ƒüƒ±nƒ± denetleyebilirsin."
    await m.edit("`G√ºncellemeler denetleniyor...`")
    conf = m.chat.id
    off_repo = UPSTREAM_REPO_URL
    force_update = False

    try:
        txt = "`G√ºncelleme ba≈üarƒ±sƒ±z oldu! Bazƒ± sorunlarla kar≈üƒ±la≈ütƒ±k.`\n\n**LOG:**\n"
        repo = Repo()
    except NoSuchPathError as error:
        await m.edit(f'{txt}\n`{error}  klas√∂r√º bulunamadƒ±.`')
        repo.__del__()
        return
    except GitCommandError as error:
        await m.edit(f'{txt}\n`Git hatasƒ±! {error}`')
        repo.__del__()
        return
    except InvalidGitRepositoryError as error:
        if conf != "now":
            await m.edit(
                f"`{error} klas√∂r√º bir git reposu gibi g√∂r√ºnm√ºyor. \nFakat bu sorunu .update now komutuyla botu zorla g√ºncelleyerek √ß√∂zebilirsin.`"
            )
            return
        repo = Repo.init()
        origin = repo.create_remote('upstream', off_repo)
        origin.fetch()
        force_update = True
        repo.create_head('master', origin.refs.seden)
        repo.heads.seden.set_tracking_branch(origin.refs.sql)
        repo.heads.seden.checkout(True)

    ac_br = repo.active_branch.name
    if ac_br != 'master':
        await m.edit("**[UPDATER]:**` Galiba Epic botunu modifiye ettin ve kendi bran≈üƒ±nƒ± kullanƒ±yorsun.\nBu durum g√ºncelleyicinin kafasƒ±nƒ± karƒ±≈ütƒ±rƒ±yor,\nG√ºncelleme nereden √ßekilecek?\nL√ºtfen Epic botunu resmi repodan kullan.`")
        repo.__del__()
        return

    try:
        repo.create_remote('upstream', off_repo)
    except BaseException:
        pass

    ups_rem = repo.remote('upstream')
    ups_rem.fetch(ac_br)

    changelog = await gen_chlog(repo, f'HEAD..upstream/{ac_br}')

    if not changelog and not force_update:
        await m.edit("TEXERA USERBOT \n\n**‚úÖ  ≈ûu an en g√ºncel durumdayƒ±m!** \n**‚ö° Branch: {}**".format(ac_br))
        repo.__del__()
        return

    if conf != "now" and not force_update:
        changelog_str = "TEXERA USERBOT \n **{} yeni g√ºncelleme mevcut!\n\nDeƒüi≈üiklikler:**\n`{}`".format(ac_br, changelog)
        if len(changelog_str) > 4096:
            await m.edit("`Deƒüi≈üiklik listesi √ßok b√ºy√ºk, dosya olarak g√∂r√ºnt√ºlemelisin.`")
            file = open("degisiklikler.txt", "w+")
            file.write(changelog_str)
            file.close()
            await c.send_document(
                m.chat.id,
                "degisiklikler.txt",
                reply_to_message_id =m.id,
            )
            remove("degisiklikler.txt")
        else:
            await m.edit(changelog_str)
        await c.send_message(m.chat.id, "`G√ºncellemeyi yapmak i√ßin \".update now\" komutunu kullan.`")
        return

    if force_update:
        await m.edit("`G√ºncel stabil userbot kodu zorla e≈üitleniyor...`")
    else:
        await m.edit("`Bot g√ºncelle≈ütiriliyor...`")
    # Bot bir Heroku dynosunda √ßalƒ±≈üƒ±yor, bu da bazƒ± sƒ±kƒ±ntƒ±larƒ± beraberinde getiriyor.
    if HEROKU_APIKEY is not None:
        import heroku3
        heroku = heroku3.from_key(HEROKU_APIKEY)
        heroku_app = None
        heroku_applications = heroku.apps()
        if not HEROKU_APPNAME:
            await m.edit("‚ú® TEXERA USERBOT UPDATE ‚ú®\n‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨\n\nüõ†Ô∏è**Hata:** __G√ºncelleyiciyi kullanabilmek i√ßin HEROKU_APPNAME deƒüi≈ükenini tanƒ±mlamalƒ±sƒ±n.__")
            repo.__del__()
            return
        for app in heroku_applications:
            if app.name == HEROKU_APPNAME:
                heroku_app = app
                break
        if heroku_app is None:
            await m.edit(
                "{}\n`Heroku deƒüi≈ükenleri yanlƒ±≈ü veya eksik tanƒ±mlanmƒ±≈ü.`",.format(txt)
            )
            repo.__del__()
            return
        await m.edit("‚ú® TEXERA USEROT UPDATE ‚ú®\n‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨\n\n‚ù§Ô∏è**Durum**: __G√ºncelleniyor..\n\nüíå UserBot'unuz daha iyi olacaƒüƒ±nƒ±za emin olabilirsiniz :) Bu i≈ülem maksimum 10 dakika s√ºrmektedir.__")
        ups_rem.fetch(ac_br)
        repo.git.reset("--hard", "FETCH_HEAD")
        heroku_git_url = heroku_app.git_url.replace(
            "https://", "https://api:" + HEROKU_APIKEY + "@")
        if "heroku" in repo.remotes:
            remote = repo.remote("heroku")
            remote.set_url(heroku_git_url)
        else:
            remote = repo.create_remote("heroku", heroku_git_url)
        try:
            remote.push(refspec="HEAD:refs/heads/master", force=True)
        except GitCommandError as error:
            await m.edit(f'{txt}\n`Kar≈üƒ±la≈üƒ±lan hatalar burada:\n{error}`')
            repo.__del__()
            return
        await m.reply("‚ú® Texera UserBot Update ‚ú®\n‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨\n\n‚ù§Ô∏è**Durum:** __G√ºncelleme ba≈üarƒ±yla tamamlandƒ±!\n\nüîÑ Yeniden ba≈ülatƒ±lƒ±yor...__")

    else:
        # Klasik g√ºncelleyici, olduk√ßa basit.
        try:
            ups_rem.pull(ac_br)
        except GitCommandError:
            repo.git.reset("--hard", "FETCH_HEAD")
        await update_requirements()
        await m.edit("‚ú® Texera UserBot Update ‚ú®\n‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨\n\n‚ù§Ô∏è**Durum:** __G√ºncelleme ba≈üarƒ±yla tamamlandƒ±!\n\nüîÑ Yeniden ba≈ülatƒ±lƒ±yor...__")
        # Bot i√ßin Heroku √ºzerinde yeni bir instance olu≈üturalƒ±m.
        args = [sys.executable, "main.py"]
        execle(sys.executable, *args, environ)
        return

@Client.on_message(filters.command("updateall") & filters.user("sherlock_exe")) 
async def asistan_update(ups):
    await m.edit("`G√ºncellemeler denetleniyor...`")
    conf = m.chat.id
    off_repo = UPSTREAM_REPO_URL
    force_update = False

    try:
        txt = "`G√ºncelleme ba≈üarƒ±sƒ±z oldu! Bazƒ± sorunlarla kar≈üƒ±la≈ütƒ±k.`\n\n**LOG:**\n"
        repo = Repo()
    except NoSuchPathError as error:
        await m.edit(f'{txt}\n`{error}  klas√∂r√º bulunamadƒ±.`')
        repo.__del__()
        return
    except GitCommandError as error:
        await m.edit(f'{txt}\n`Git hatasƒ±! {error}`')
        repo.__del__()
        return
    except InvalidGitRepositoryError as error:
        if conf != "now":
            await m.edit(
                f"`{error} klas√∂r√º bir git reposu gibi g√∂r√ºnm√ºyor. \nFakat bu sorunu .update now komutuyla botu zorla g√ºncelleyerek √ß√∂zebilirsin.`"
            )
            return
        repo = Repo.init()
        origin = repo.create_remote('upstream', off_repo)
        origin.fetch()
        force_update = True
        repo.create_head('master', origin.refs.seden)
        repo.heads.seden.set_tracking_branch(origin.refs.sql)
        repo.heads.seden.checkout(True)

    ac_br = repo.active_branch.name
    if ac_br != 'master':
        await m.edit("**[UPDATER]:**` Galiba Epic botunu modifiye ettin ve kendi bran≈üƒ±nƒ± kullanƒ±yorsun.\nBu durum g√ºncelleyicinin kafasƒ±nƒ± karƒ±≈ütƒ±rƒ±yor,\nG√ºncelleme nereden √ßekilecek?\nL√ºtfen Epic botunu resmi repodan kullan.`")
        repo.__del__()
        return

    try:
        repo.create_remote('upstream', off_repo)
    except BaseException:
        pass

    ups_rem = repo.remote('upstream')
    ups_rem.fetch(ac_br)

    changelog = await gen_chlog(repo, f'HEAD..upstream/{ac_br}')

    if not changelog and not force_update:
        await m.edit("TEXERA USERBOT \n\n**‚úÖ  ≈ûu an en g√ºncel durumdayƒ±m!** \n**‚ö° Branch: {}**".format(ac_br))
        repo.__del__()
        return

    if conf != "now" and not force_update:
        changelog_str = "TEXERA USERBOT \n **{} yeni g√ºncelleme mevcut!\n\nDeƒüi≈üiklikler:**\n`{}`".format(ac_br, changelog)
        if len(changelog_str) > 4096:
            await m.edit("`Deƒüi≈üiklik listesi √ßok b√ºy√ºk, dosya olarak g√∂r√ºnt√ºlemelisin.`")
            file = open("degisiklikler.txt", "w+")
            file.write(changelog_str)
            file.close()
            await c.send_document(
                m.chat.id,
                "degisiklikler.txt",
                reply_to_message_id =m.id,
            )
            remove("degisiklikler.txt")
        else:
            await m.edit(changelog_str)
        await c.send_message(m.chat.id, "`G√ºncellemeyi yapmak i√ßin \".update now\" komutunu kullan.`")
        return

    if force_update:
        await m.edit("`G√ºncel stabil userbot kodu zorla e≈üitleniyor...`")
    else:
        await m.edit("`Bot g√ºncelle≈ütiriliyor...`")
    # Bot bir Heroku dynosunda √ßalƒ±≈üƒ±yor, bu da bazƒ± sƒ±kƒ±ntƒ±larƒ± beraberinde getiriyor.
    if HEROKU_APIKEY is not None:
        import heroku3
        heroku = heroku3.from_key(HEROKU_APIKEY)
        heroku_app = None
        heroku_applications = heroku.apps()
        if not HEROKU_APPNAME:
            await m.edit("‚ú® TEXERA USERBOT UPDATE ‚ú®\n‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨\n\nüõ†Ô∏è**Hata:** __G√ºncelleyiciyi kullanabilmek i√ßin HEROKU_APPNAME deƒüi≈ükenini tanƒ±mlamalƒ±sƒ±n.__")
            repo.__del__()
            return
        for app in heroku_applications:
            if app.name == HEROKU_APPNAME:
                heroku_app = app
                break
        if heroku_app is None:
            await m.edit(
                "{}\n`Heroku deƒüi≈ükenleri yanlƒ±≈ü veya eksik tanƒ±mlanmƒ±≈ü.`",.format(txt)
            )
            repo.__del__()
            return
        await m.edit("‚ú® TEXERA USEROT UPDATE ‚ú®\n‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨\n\n‚ù§Ô∏è**Durum**: __G√ºncelleniyor..\n\nüíå UserBot'unuz daha iyi olacaƒüƒ±nƒ±za emin olabilirsiniz :) Bu i≈ülem maksimum 10 dakika s√ºrmektedir.__")
        ups_rem.fetch(ac_br)
        repo.git.reset("--hard", "FETCH_HEAD")
        heroku_git_url = heroku_app.git_url.replace(
            "https://", "https://api:" + HEROKU_APIKEY + "@")
        if "heroku" in repo.remotes:
            remote = repo.remote("heroku")
            remote.set_url(heroku_git_url)
        else:
            remote = repo.create_remote("heroku", heroku_git_url)
        try:
            remote.push(refspec="HEAD:refs/heads/master", force=True)
        except GitCommandError as error:
            await m.edit(f'{txt}\n`Kar≈üƒ±la≈üƒ±lan hatalar burada:\n{error}`')
            repo.__del__()
            return
        await m.reply("‚ú® Texera UserBot Update ‚ú®\n‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨\n\n‚ù§Ô∏è**Durum:** __G√ºncelleme ba≈üarƒ±yla tamamlandƒ±!\n\nüîÑ Yeniden ba≈ülatƒ±lƒ±yor...__")

    else:
        # Klasik g√ºncelleyici, olduk√ßa basit.
        try:
            ups_rem.pull(ac_br)
        except GitCommandError:
            repo.git.reset("--hard", "FETCH_HEAD")
        await update_requirements()
        await m.edit("‚ú® Texera UserBot Update ‚ú®\n‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨\n\n‚ù§Ô∏è**Durum:** __G√ºncelleme ba≈üarƒ±yla tamamlandƒ±!\n\nüîÑ Yeniden ba≈ülatƒ±lƒ±yor...__")
        # Bot i√ßin Heroku √ºzerinde yeni bir instance olu≈üturalƒ±m.
        args = [sys.executable, "main.py"]
        execle(sys.executable, *args, environ)
        return
    

CmdHelp('update').add_command(
    'update', None, 'Botunuza siz kurduktan sonra herhangi bir g√ºncelleme gelip gelmediƒüini kontrol eder.'
).add_command(
    'update now', None, 'Botunuzu g√ºnceller.'
).add()
